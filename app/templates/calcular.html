{% extends "base.html" %}
{% block title %}Calcular Meta — Sistema de Metas{% endblock %}
{% block page_title %}Calcular Meta Ajustada{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card shadow-sm p-4">
    <h5 class="mb-4"><i class="bi bi-calculator-fill text-success"></i> Calcular Meta Ajustada</h5>

    <form id="calcForm" class="row g-4">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Modelo</label>
        <select class="form-select form-select-lg" name="codigo" required>
          {% for c in codigos %}
            <option>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Pessoas atuais</label>
        <input class="form-control form-control-lg" name="pessoas_atuais" type="number" required>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Minutos</label>
        <input class="form-control form-control-lg" name="minutos" type="number" value="60" required>
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-success btn-lg w-100" type="submit">
          <i class="bi bi-play-circle"></i> Calcular
        </button>
      </div>
    </form>

    <div id="resultadoCalc" class="mt-4 p-3 border rounded shadow-sm bg-light text-center fw-semibold"></div>
  </div>

  <hr class="my-5">

  <div class="card shadow-sm p-4 mt-4">
    <h5 class="mb-4"><i class="bi bi-lightning-charge-fill text-primary"></i> Cálculo Rápido (Meta/Hora x Minutos)</h5>

    <form id="calcRapidoForm" class="row g-4">

      <div class="col-md-4">
        <label class="form-label fw-semibold">Meta por hora</label>
        <input class="form-control form-control-lg" type="number" name="meta_hora" required>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">Minutos</label>
        <input class="form-control form-control-lg" type="number" name="minutos" value="60" required>
      </div>

    <div class="col-md-4" id="campoBlank" style="display:none;">
        <label class="form-label fw-semibold">Blank</label>
        <input class="form-control form-control-lg" type="number" name="blank" value="0">
    </div>

  <div class="col-md-4 d-flex align-items-center">
      <div class="form-check form-switch mt-4">
          <input class="form-check-input" type="checkbox" id="usarBlank" name="usar_blank">
          <label class="form-check-label fw-semibold" for="usarBlank">Considerar Blank</label>
      </div>
  </div>

  <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-primary btn-lg w-100" type="submit">
          <i class="bi bi-play-circle"></i> Calcular
        </button>
      </div>
    </form>
   
    <div id="resultadoCalcRapido" class="mt-4 p-3 border rounded shadow-sm bg-light text-center fw-semibold"></div>
  </div>

<hr class="my-5">

<div class="card shadow-sm p-4">
  <h5 class="mb-4">
    <i class="bi bi-stopwatch-fill text-danger"></i>
    Cálculo SMT (Manual / Cronômetro)
  </h5>

  <form id="smtForm" class="row g-4">

    <div class="col-md-4">
      <label class="form-label fw-semibold">Tempo de montagem (s)</label>
      <input id="tempoMontagem" class="form-control form-control-lg" type="number" step="0.01">
    </div>

    <div class="col-md-4">
      <label class="form-label fw-semibold">Placas por blank</label>
      <input id="blankSMT" class="form-control form-control-lg" type="number" required>
    </div>

    <div class="col-md-4 d-flex align-items-end gap-2">
      <button id="startTimer" type="button" class="btn btn-outline-success w-100">
        ▶ Start
      </button>
      <button id="stopTimer" type="button" class="btn btn-outline-danger w-100">
        ⏹ Stop
      </button>
    </div>

    <div class="col-12">
      <button class="btn btn-danger btn-lg w-100" type="submit">
        Calcular Meta SMT
      </button>
    </div>
  </form>

  <div id="resultadoSMT"
       class="mt-4 p-3 border rounded bg-light text-center fw-semibold">
  </div>
</div>

<hr class="my-5">

<div class="card shadow-sm p-4">
  <h5 class="mb-4">
    <i class="bi bi-arrow-left-right text-primary"></i>
    Cálculo SMT Inverso 
  </h5>

  <form id="smtInversoForm" class="row g-4">

    <div class="col-md-6">
      <label class="form-label fw-semibold">Meta por hora</label>
      <input id="metaHoraInv" class="form-control form-control-lg" type="number" required>
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Placas por blank</label>
      <input id="blankInv" class="form-control form-control-lg" type="number" required>
    </div>

    <div class="col-12">
      <button class="btn btn-outline-primary btn-lg w-100" type="submit">
        Calcular Tempo de Montagem
      </button>
    </div>
  </form>

  <div id="resultadoInverso"
       class="mt-4 p-3 border rounded bg-light text-center fw-semibold">
  </div>
</div>

</div>

<script>
let inicio = null;
let intervalo = null;

const inputTempo = document.getElementById('tempoMontagem');

document.getElementById('startTimer').addEventListener('click', () => {
  inicio = performance.now();
  inputTempo.value = '';
});

document.getElementById('stopTimer').addEventListener('click', () => {
  if (!inicio) return;

  const fim = performance.now();
  const segundos = (fim - inicio) / 1000;

  inputTempo.value = segundos.toFixed(2);
  inicio = null;
});
</script>

<script>
document.getElementById("smtForm").addEventListener("submit", async e => {
  e.preventDefault();

  const fd = new FormData();
  fd.append("tempo_montagem", document.getElementById("tempoMontagem").value);
  fd.append("blank", document.getElementById("blankSMT").value);

  const r = await fetch("/api/smt/calcular_meta", { method: "POST", body: fd });
  const data = await r.json();

  if (!data.sucesso) {
    document.getElementById("resultadoSMT").innerHTML =
      `<span class="text-danger">${data.erro}</span>`;
    return;
  }

  document.getElementById("resultadoSMT").innerHTML = `
    Meta Operacional: <strong>${data.dados.meta_hora}</strong><br>
    Capacidade Teórica da Máquina: <strong>${data.dados.meta_teorica}</strong><br>
    
  `;
});
</script>

<script>
const usarBlankCheckbox = document.getElementById("usarBlank");
const campoBlank = document.getElementById("campoBlank");

usarBlankCheckbox.addEventListener("change", () => {
  campoBlank.style.display = usarBlankCheckbox.checked ? "block" : "none";
});

document.getElementById("calcRapidoForm").addEventListener("submit", async e => {
  e.preventDefault();

  const form = e.target;
  const fd = new FormData(form);

  // se não usar blank, remove
  if (!usarBlankCheckbox.checked) {
    fd.delete("blank");
  }

  const r = await fetch("/api/modelos/calculo_rapido", {
    method: "POST",
    body: fd
  });

  const data = await r.json();

  if (!data.sucesso) {
    document.getElementById("resultadoCalcRapido").innerHTML =
      `<span class="text-danger">${data.erro}</span>`;
    return;
  }

  let html = "";

  if (data.dados.blanks !== undefined) {
    html = `
      Blanks: <strong>${data.dados.blanks}</strong><br>
      Placas Reais: <strong>${data.dados.placas_reais}</strong>
    `;
  } else {
    html = `
      Produção estimada: <strong>${data.dados.placas}</strong> placas
    `;
  }

  document.getElementById("resultadoCalcRapido").innerHTML = html;
});
</script>

<script>
document.getElementById('calcForm').addEventListener('submit', async e => {
  e.preventDefault();

  const resp = await fetch('/api/modelos/calcular', {
    method: 'POST',
    body: new FormData(e.target)
  });

  const data = await resp.json();

  document.getElementById('resultadoCalc').innerHTML =
    data.resultado ?? 'Erro no cálculo';
});
</script>

<script>
document.getElementById("smtInversoForm").addEventListener("submit", async e => {
  e.preventDefault();

  const fd = new FormData();
  fd.append("meta_hora", document.getElementById("metaHoraInv").value);
  fd.append("blank", document.getElementById("blankInv").value);

  const r = await fetch("/api/smt/calcular_tempo", {
    method: "POST",
    body: fd
  });

  const data = await r.json();

  if (!data.sucesso) {
    document.getElementById("resultadoInverso").innerHTML =
      `<span class="text-danger">${data.erro}</span>`;
    return;
  }

  document.getElementById("resultadoInverso").innerHTML =
    `Tempo de montagem considerado: <strong>${data.dados.tempo_montagem}s</strong>`;
});

</script>


{% endblock %}
