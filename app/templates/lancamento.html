{% extends "base.html" %}
{% block title %}Lançamento Diário{% endblock %}
{% block page_title %}Venttos - Factory Metrics - Lançamento de Absenteísmo{% endblock %}

{% block content %}
<form id="formLancamento"
      method="post"
      action="{{ url_for('api.api_criar_lancamento') }}">

  <div class="row g-3">

    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" name="data" class="form-control" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Filial</label>
      <select name="filial" class="form-select" required>
        <option value="VTE">VTE</option>
        <option value="VTT">VTT</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Setor</label>
      <select name="setor" class="form-select" required>
        <option value="SMT">SMT</option>
        <option value="PTH">PTH</option>
        <option value="IM">IM</option>
        <option value="PA">PA</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Linha</label>
      <input name="linha" class="form-control" placeholder="PA-04.12" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Turno</label>
      <select name="turno" class="form-select" required>
        <option value="1T">1º Turno</option>
        <option value="2T">2º Turno</option>
        <option value="3T">3º Turno</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Padrão</label>
      <input type="number" name="hc_padrao" class="form-control" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Real</label>
      <input type="number" name="hc_real" class="form-control" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">Férias</label>
      <input type="number" name="ferias" class="form-control">
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary w-100">
        Salvar Lançamento
      </button>
    </div>

  </div>
</form>

<!-- Mensagem de resultado -->
<div id="msgLancamento" class="mt-3"></div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById("formLancamento").addEventListener("submit", async function(e){
    e.preventDefault(); // previne o envio padrão

    const formData = new FormData(this);

    try {
        const resp = await fetch(this.action, {
            method: "POST",
            body: formData
        });

        const data = await resp.json();
        const msgDiv = document.getElementById("msgLancamento");

        if(data.sucesso){
            msgDiv.innerHTML = `
                <div class="alert alert-success">
                    Lançamento salvo com sucesso! Absenteísmo calculado: <strong>${data.absenteismo}%</strong>
                </div>
            `;
            this.reset(); // limpa o formulário
        } else {
            msgDiv.innerHTML = `
                <div class="alert alert-danger">
                    Ocorreu um erro ao salvar o lançamento.
                </div>
            `;
        }
    } catch(err){
        document.getElementById("msgLancamento").innerHTML = `
            <div class="alert alert-danger">
                Erro de conexão. Tente novamente.
            </div>
        `;
        console.error(err);
    }
});
</script>
{% endblock %}
