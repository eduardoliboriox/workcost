{% extends "base.html" %}
{% block title %}Lançamento de Absenteísmo{% endblock %}
{% block page_title %}Venttos - Factory Metrics - Lançamento{% endblock %}

{% block content %}
<form id="formLancamento"
      method="post"
      action="{{ url_for('api.api_criar_lancamento') }}">

  <!-- JSONs enviados -->
  <input type="hidden" name="cargos" id="cargosJson">
  <input type="hidden" name="ferias" id="feriasJson">

  <div class="row g-3">

    <!-- ================= DADOS GERAIS ================= -->

    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" name="data" class="form-control" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Filial</label>
      <select name="filial" class="form-select" required>
        <option value="VTE">VTE</option>
        <option value="VTT">VTT</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Setor</label>
      <select name="setor" class="form-select" required>
        <option value="IM">IM</option>
        <option value="PA">PA</option>
        <option value="SMT">SMT</option>
        <option value="PTH">PTH</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Linha</label>
      <select name="linha" id="linhaSelect" class="form-select" required>
        <option value="">Selecione o setor</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Turno</label>
      <select name="turno" class="form-select" required>
        <option value="1T">1º Turno</option>
        <option value="2T">2º Turno</option>
        <option value="3T">3º Turno</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Padrão</label>
      <input type="number" name="hc_padrao" class="form-control" required oninput="atualizarHCReal()">
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Real</label>
      <input type="number" name="hc_real" class="form-control" readonly>
    </div>

    <hr>

    <!-- ================= ABSENTEÍSMO ================= -->

    <h6 class="fw-bold mt-3">Absenteísmo por Cargo</h6>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Cargo</label>
        <select id="cargo" class="form-select">
          <option value="">Selecione</option>
          <optgroup label="Área Técnica">
            {% for c in cargos_tecnica %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </optgroup>
          <optgroup label="Produção">
            {% for c in cargos_producao %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </optgroup>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Qtd</label>
        <input type="number" id="qtd" class="form-control" min="1">
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button type="button" class="btn btn-secondary w-100" onclick="addCargo()">
          Adicionar
        </button>
      </div>
    </div>

    <ul id="listaCargos" class="list-group mt-3"></ul>

    <hr>

    <!-- ================= FÉRIAS ================= -->

    <h6 class="fw-bold mt-3">Férias por Cargo</h6>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Cargo</label>
        <select id="cargoFerias" class="form-select">
          <option value="">Selecione</option>
          <optgroup label="Área Técnica">
            {% for c in cargos_tecnica %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </optgroup>
          <optgroup label="Produção">
            {% for c in cargos_producao %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </optgroup>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Qtd</label>
        <input type="number" id="qtdFerias" class="form-control" min="1">
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button type="button" class="btn btn-info w-100" onclick="addFerias()">
          Adicionar
        </button>
      </div>
    </div>

    <ul id="listaFerias" class="list-group mt-3"></ul>

    <div class="col-12 mt-4">
      <button type="submit" class="btn btn-primary w-100">
        Salvar Lançamento
      </button>
    </div>

  </div>
</form>

<div id="msgLancamento" class="mt-3"></div>
{% endblock %}

{% block scripts %}
<script>
let cargos = [];
let ferias = [];

/* ========= ABSENTEÍSMO ========= */
function addCargo() {
  const select = document.getElementById("cargo");
  const qtdInput = document.getElementById("qtd");

  const cargoId = select.value;
  const cargoNome = select.options[select.selectedIndex].text;
  const qtd = parseInt(qtdInput.value, 10);

  if (!cargoId || !qtd) return alert("Informe cargo e quantidade");

  cargos.push({ cargo_id: +cargoId, quantidade: qtd });

  document.getElementById("listaCargos").innerHTML += `
    <li class="list-group-item d-flex justify-content-between">
      ${cargoNome}
      <span class="badge bg-primary">${qtd}</span>
    </li>`;

  atualizarHCReal();
  atualizarJsons();

  select.value = "";
  qtdInput.value = "";
}

/* ========= FÉRIAS ========= */
function addFerias() {
  const select = document.getElementById("cargoFerias");
  const qtdInput = document.getElementById("qtdFerias");

  const cargoId = select.value;
  const cargoNome = select.options[select.selectedIndex].text;
  const qtd = parseInt(qtdInput.value, 10);

  if (!cargoId || !qtd) return alert("Informe cargo e quantidade");

  ferias.push({
    cargo_id: +cargoId,
    quantidade: qtd,
    tipo: "FERIAS"
  });

  document.getElementById("listaFerias").innerHTML += `
    <li class="list-group-item d-flex justify-content-between">
      ${cargoNome}
      <span class="badge bg-info">${qtd}</span>
    </li>`;

  atualizarJsons();

  select.value = "";
  qtdInput.value = "";
}

/* ========= UTIL ========= */
function atualizarHCReal(){
  const hcPadrao = +document.querySelector("[name='hc_padrao']").value || 0;
  const faltas = cargos.reduce((s,c)=>s+c.quantidade,0);
  document.querySelector("[name='hc_real']").value = Math.max(hcPadrao - faltas, 0);
}

function atualizarJsons(){
  document.getElementById("cargosJson").value = JSON.stringify(cargos);
  document.getElementById("feriasJson").value = JSON.stringify(ferias);
}

/* ========= LINHAS ========= */
const linhasPorSetor = {
  IM:["IM-01","IM-02","IM-03","IM-04","IM-05","IM-06"],
  PA:["IP-COM","PA-01","PA-03","PA-04","PA-07","PA-08","PA-09","PA-13","WIFI"],
  PTH:["ADE-01","AXI-01","AXI-02","AXI-03","JUM-01","JUM-02","RAD-01","RAD-02","RAD-03","ROU-01","ROU-02","ROU-03"],
  SMT:["SMT-01","SMT-02","SMT-03","SMT-04","SMT-05","SMT-06","SMT-07","SMT-08","SMT-09"]
};

const setorSelect = document.querySelector("[name='setor']");
const linhaSelect = document.getElementById("linhaSelect");

function atualizarLinhas(){
  linhaSelect.innerHTML = `<option value="">Selecione</option>`;
  (linhasPorSetor[setorSelect.value] || []).forEach(l=>{
    linhaSelect.innerHTML += `<option value="${l}">${l}</option>`;
  });
}

setorSelect.addEventListener("change", atualizarLinhas);
document.addEventListener("DOMContentLoaded", atualizarLinhas);

/* ========= MENSAGEM AMIGÁVEL AO SALVAR ========= */
const form = document.getElementById("formLancamento");
const msgDiv = document.getElementById("msgLancamento");

form.addEventListener("submit", async function(e){
  e.preventDefault();

  atualizarJsons(); // garante que os JSONs estão atualizados

  const data = new FormData(form);
  
  try {
    const response = await fetch(form.action, {
      method: "POST",
      body: data
    });

    const result = await response.json();

    if(response.ok && result.success){  // ✅ consistente
      msgDiv.innerHTML = `<div class="alert alert-success">Lançamento salvo com sucesso! ✅</div>`;
      form.reset();
      cargos = [];
      ferias = [];
      document.getElementById("listaCargos").innerHTML = "";
      document.getElementById("listaFerias").innerHTML = "";
      atualizarHCReal();
      atualizarLinhas();
    } else {
      msgDiv.innerHTML = `<div class="alert alert-danger">Erro ao salvar: ${result.error || 'Verifique os dados.'}</div>`;
    }

  } catch(err){
    msgDiv.innerHTML = `<div class="alert alert-danger">Erro de conexão. Tente novamente.</div>`;
    console.error(err);
  }
});
</script>
{% endblock %}
