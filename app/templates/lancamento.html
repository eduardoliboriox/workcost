{% extends "base.html" %}
{% block title %}Lan√ßamento de Absente√≠smo{% endblock %}
{% block page_title %}Venttos - Factory Metrics - Lan√ßamento de Absente√≠smo{% endblock %}

{% block content %}
<form id="formLancamento"
      method="post"
      action="{{ url_for('api.api_criar_lancamento') }}">

  <!-- üî¥ CAMPO OCULTO PARA ENVIAR OS CARGOS -->
  <input type="hidden" name="cargos" id="cargosJson">

  <div class="row g-3">

    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" name="data" class="form-control" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Filial</label>
      <select name="filial" class="form-select" required>
        <option value="VTE">VTE</option>
        <option value="VTT">VTT</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Setor</label>
      <select name="setor" class="form-select" required>
        <option value="SMT">SMT</option>
        <option value="PTH">PTH</option>
        <option value="IM">IM</option>
        <option value="PA">PA</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Linha</label>
      <input name="linha" class="form-control" placeholder="PA-04.12" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Turno</label>
      <select name="turno" class="form-select" required>
        <option value="1T">1¬∫ Turno</option>
        <option value="2T">2¬∫ Turno</option>
        <option value="3T">3¬∫ Turno</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Padr√£o</label>
      <input type="number" name="hc_padrao" class="form-control" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">HC Real</label>
      <input type="number" name="hc_real" class="form-control" required>
    </div>

    <div class="col-md-4">
      <label class="form-label">F√©rias</label>
      <input type="number" name="ferias" class="form-control">
    </div>

    <hr>

    <h6 class="fw-bold mt-3">Absente√≠smo por Cargo</h6>

    <div class="row g-3">

      <div class="col-md-6">
        <label class="form-label">Cargo</label>
        <select id="cargo" class="form-select">
          <option value="">Selecione</option>
          {% for c in cargos %}
            <option value="{{ c.id }}">{{ c.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Qtd</label>
        <input type="number" id="qtd" class="form-control" min="1">
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button type="button" class="btn btn-secondary w-100" onclick="addCargo()">
          Adicionar
        </button>
      </div>

    </div>

    <ul id="listaCargos" class="list-group mt-3"></ul>

    <div class="col-12">
      <button type="submit" class="btn btn-primary w-100">
        Salvar Lan√ßamento
      </button>
    </div>

  </div>
</form>

<!-- Mensagem de resultado -->
<div id="msgLancamento" class="mt-3"></div>

{% endblock %}

{% block scripts %}

<script>
let cargos = [];

function addCargo() {
    const cargoSelect = document.getElementById("cargo");
    const qtdInput = document.getElementById("qtd");

    const cargoId = cargoSelect.value;
    const cargoNome = cargoSelect.options[cargoSelect.selectedIndex].text;
    const qtd = parseInt(qtdInput.value);

    if (!cargoId || !qtd || qtd <= 0) {
        alert("Selecione um cargo e informe a quantidade.");
        return;
    }

    cargos.push({
        cargo_id: parseInt(cargoId),
        quantidade: qtd
    });

    document.getElementById("listaCargos").innerHTML += `
        <li class="list-group-item d-flex justify-content-between">
            ${cargoNome}
            <span class="badge bg-primary">${qtd}</span>
        </li>
    `;

    // atualiza o hidden corretamente
    document.getElementById("cargosJson").value = JSON.stringify(cargos);

    cargoSelect.value = "";
    qtdInput.value = "";
}
</script>

<script>
document.getElementById("formLancamento").addEventListener("submit", async function(e){
    e.preventDefault();

    // garante envio dos cargos
    document.getElementById("cargosJson").value = JSON.stringify(cargos);

    const formData = new FormData(this);

    try {
        const resp = await fetch(this.action, {
            method: "POST",
            body: formData
        });

        const data = await resp.json();
        const msgDiv = document.getElementById("msgLancamento");

        if(data.sucesso){
            msgDiv.innerHTML = `
                <div class="alert alert-success">
                    Lan√ßamento salvo com sucesso! Absente√≠smo calculado:
                    <strong>${data.absenteismo}%</strong>
                </div>
            `;
            this.reset();
            cargos = [];
            document.getElementById("listaCargos").innerHTML = "";
        } else {
            msgDiv.innerHTML = `
                <div class="alert alert-danger">
                    Ocorreu um erro ao salvar o lan√ßamento.
                </div>
            `;
        }
    } catch(err){
        msgDiv.innerHTML = `
            <div class="alert alert-danger">
                Erro de conex√£o. Tente novamente.
            </div>
        `;
        console.error(err);
    }
});
</script>

{% endblock %}
