{% extends "base.html" %}
{% block title %}Modelos â€” Sistema de Metas{% endblock %}
{% block page_title %}Modelos Cadastrados{% endblock %}

{% block content %}
<div class="container-fluid">

  <div id="mensagemModelos"></div>

  <!-- ===================== LISTA DE MODELOS ===================== -->
  <div class="card mb-4 p-3 shadow-sm">
    <h5 class="mb-3 text-success">
      <i class="bi bi-table text-success"></i> Modelos Cadastrados
    </h5>

    <div class="d-flex gap-2 mb-3">
      <a href="#editar-modelo" class="btn btn-warning btn-sm fw-bold">
        <i class="bi bi-pencil-square text-white"></i> Editar Modelo
      </a>

      <a href="#excluir-modelo" class="btn btn-danger btn-sm fw-bold">
        <i class="bi bi-trash3"></i> Excluir Modelo
      </a>
    </div>

    <input
      id="buscaModelo"
      class="form-control mb-3"
      placeholder="ðŸ”Ž Buscar por cÃ³digo, cliente ou setor"
    >

    <div id="listaModelos" class="row g-3"></div>
  </div>

  <!-- ===================== EDITAR MODELO ===================== -->
  <div id="editar-modelo" class="card mb-4 p-3 shadow-sm">
    <h5 class="mb-3 text-warning">
      <i class="bi bi-pencil-square"></i> Editar Modelo
    </h5>

    <form id="editarForm" class="row g-3">

      <div class="col-md-3">
        <label class="form-label fw-bold">Cliente</label>
        <select class="form-select" id="filtroCliente">
          <option value="">Selecione</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">Modelo (cÃ³digo + fase)</label>
        <select class="form-select" name="modelo" id="selectEditar" required>
          <option value="">Selecione o cliente primeiro</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">Nova Meta/Hora</label>
        <input class="form-control" name="meta_padrao" type="number" step="0.01"
               placeholder="Deixe vazio para manter">
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">Novo Tempo de Montagem (s)</label>
        <input class="form-control" name="tempo_montagem" type="number" step="0.01"
               placeholder="Deixe vazio para manter">
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">Placas por blank</label>
        <input class="form-control" name="blank" type="number" min="1"
               placeholder="Deixe vazio para manter">
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">Corrigir CÃ³digo (opcional)</label>
        <input class="form-control" name="novo_codigo" type="text"
               placeholder="SÃ³ se digitou errado">
      </div>

      <div class="col-md-12">
        <button class="btn btn-warning w-100 fw-bold text-white">Atualizar</button>
      </div>

    </form>
  </div>

  <!-- ===================== EXCLUIR MODELO ===================== -->
  <div id="excluir-modelo" class="card mb-4 p-3 shadow-sm">
    <h5 class="mb-3 text-danger">
      <i class="bi bi-trash3 fw-bold"></i> Excluir Modelo
    </h5>

<form id="excluirForm" class="row g-3">

  <div class="col-md-3">
    <label class="form-label fw-bold">Cliente</label>
    <select class="form-select" id="filtroClienteExcluir">
      <option value="">Selecione</option>
    </select>
  </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">Modelo (cÃ³digo + fase)</label>
        <select class="form-select" name="modelo" id="selectExcluir" required>
          <option value="">Selecione o cliente primeiro</option>
        </select>
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-danger w-100 fw-bold text-white">Excluir</button>
      </div>
    </form>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function(){

  let modelosCache = [];

  // ================= LISTAR MODELOS =================
  function carregarModelos() {
    fetch('/api/modelos')
      .then(r => r.json())
      .then(data => {
        modelosCache = data;

        const container = $('#listaModelos');
        container.empty();

        if (data.length === 0) {
          container.html('<p class="text-muted">Nenhum modelo cadastrado.</p>');
          return;
        }

        data.forEach(m => {
          container.append(`
            <div class="col-md-4 col-lg-3">
              <div class="card-modelo shadow-sm">
                <div class="d-flex justify-content-between">
                  <div class="codigo">${m.codigo}</div>
                  <div class="cliente">${m.cliente}</div>
                </div>

                <div class="linha"><strong>Setor:</strong> ${m.setor}</div>
                <div class="linha"><strong>Meta/hora:</strong> ${m.meta}</div>
                <div class="linha"><strong>Tempo de montagem:</strong> ${m.tempo_montagem ?? '-'}</div>
                <div class="linha"><strong>Placas por blank:</strong> ${m.blank}</div>
                <div class="linha"><strong>Fase:</strong> ${m.fase}</div>
              </div>
            </div>
          `);
        });

        popularFiltros();
      });
  }

  // ================= FILTROS =================
  function popularFiltros() {
    const clientes = [...new Set(modelosCache.map(m => m.cliente))];
    const filtroCliente = $('#filtroCliente');
    const filtroClienteExcluir = $('#filtroClienteExcluir');
    const selectExcluir = $('#selectExcluir');

    filtroCliente.empty().append('<option value="">Selecione</option>');
    clientes.forEach(c => filtroCliente.append(`<option value="${c}">${c}</option>`));

    filtroClienteExcluir.empty().append('<option value="">Selecione</option>');
    clientes.forEach(c => {
      filtroClienteExcluir.append(`<option value="${c}">${c}</option>`);
    });

  }

  $('#filtroCliente').on('change', function(){
    const cliente = $(this).val();
    const selectEditar = $('#selectEditar');

    selectEditar.empty();

    modelosCache
      .filter(m => m.cliente === cliente)
      .forEach(m => {
        selectEditar.append(`
          <option value="${m.codigo}|${m.fase}">
            ${m.codigo} â€” ${m.fase}
          </option>
        `);
      });
  });

  $('#filtroClienteExcluir').on('change', function(){
    const cliente = $(this).val();
    const selectExcluir = $('#selectExcluir');

    selectExcluir.empty();

    if (!cliente) {
      selectExcluir.append('<option value="">Selecione o cliente primeiro</option>');
      return;
    }

    modelosCache
      .filter(m => m.cliente === cliente)
      .forEach(m => {
        selectExcluir.append(`
          <option value="${m.codigo}|${m.fase}">
            ${m.codigo} â€” ${m.fase}
          </option>
        `);
      });
  });

  // ================= MENSAGEM =================
  function mostrarMensagem(texto, tipo='success') {
    const div = $(`
      <div class="alert alert-${tipo} alert-dismissible fade show">
        ${texto}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `);
    $('#mensagemModelos').html(div);
    setTimeout(() => div.alert('close'), 2000);
  }

  // ================= EDITAR =================
  $('#editarForm').on('submit', async function(e){
    e.preventDefault();

    const fd = new FormData(this);
    const [codigo, fase] = fd.get('modelo').split('|');

    fd.append('codigo', codigo);
    fd.append('fase', fase);
    fd.delete('modelo');

    await fetch('/api/modelos', { method:'PUT', body: fd });

    mostrarMensagem('Modelo atualizado com sucesso!', 'success');
    carregarModelos();
  });

  // ================= EXCLUIR =================
  $('#excluirForm').on('submit', async function(e){
    e.preventDefault();

    const fd = new FormData(this);
    const [codigo, fase] = fd.get('modelo').split('|');

    fd.append('codigo', codigo);
    fd.append('fase', fase);
    fd.delete('modelo');

    await fetch('/api/modelos', { method:'DELETE', body: fd });

    mostrarMensagem('Modelo excluÃ­do com sucesso!', 'danger');
    carregarModelos();
  });

  // ================= BUSCA =================
  $('#buscaModelo').on('input', function () {
    const termo = $(this).val().toLowerCase();
    $('#listaModelos .col-md-4').each(function () {
      $(this).toggle($(this).text().toLowerCase().includes(termo));
    });
  });

  carregarModelos();
});
</script>
{% endblock %}
